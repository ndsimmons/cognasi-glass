---
// Shop Page - All Pieces
import { products, formatPrice } from '../data/products';
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Shop - Cognasi Glass Co.</title>
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
	</head>
	<body>
		<!-- Navigation -->
		<nav class="navbar">
			<div class="container">
				<div class="nav-wrapper">
					<a href="/logo" class="logo">
						<img src="/logo-cropped.jpg" alt="Cognasi Glass Co." />
					</a>
					<ul class="nav-links">
						<li><a href="/">Home</a></li>
						<li><a href="/shop" class="active">Shop</a></li>
						<li><a href="/about">About Us</a></li>
						<li>
							<button class="search-btn" aria-label="Search">
								<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<circle cx="11" cy="11" r="8"></circle>
									<path d="m21 21-4.35-4.35"></path>
								</svg>
							</button>
						</li>
						<li>
							<button class="cart-btn" aria-label="Shopping Cart" id="cart-toggle">
								<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<circle cx="9" cy="21" r="1"></circle>
									<circle cx="20" cy="21" r="1"></circle>
									<path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
								</svg>
								<span class="cart-count" id="cart-count">0</span>
							</button>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<!-- Shop Section -->
		<section class="shop">
			<div class="container">
				<h1 class="page-title">Our Collection</h1>
				<p class="page-subtitle">Handcrafted stained glass pieces, each one unique and made with love</p>
				<div class="gallery-grid">
					{products.map(product => (
						<div class="gallery-item">
							<div class="item-image">
								<img src={product.image} alt={product.description} />
							</div>
							<h3>{product.name}</h3>
							<p class="price">{formatPrice(product.price)}</p>
							<div class="item-actions">
								<button 
									class="btn btn-primary add-to-cart-btn" 
									data-product-id={product.id}
								>
									Add to Cart
								</button>
								<button 
									class="btn btn-secondary buy-now-btn" 
									data-product-id={product.id}
								>
									Buy Now
								</button>
							</div>
						</div>
					))}
				</div>
			</div>
		</section>

		<!-- Cart Sidebar -->
		<div class="cart-sidebar" id="cart-sidebar">
			<div class="cart-overlay" id="cart-overlay"></div>
			<div class="cart-content">
				<div class="cart-header">
					<h2>Shopping Cart</h2>
					<button class="cart-close" id="cart-close" aria-label="Close cart">
						<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<line x1="18" y1="6" x2="6" y2="18"></line>
							<line x1="6" y1="6" x2="18" y2="18"></line>
						</svg>
					</button>
				</div>
				<div class="cart-items" id="cart-items">
					<!-- Cart items will be dynamically inserted here -->
				</div>
				<div class="cart-footer">
					<div class="cart-total">
						<span>Total:</span>
						<span id="cart-total">$0.00</span>
					</div>
					<button class="btn btn-primary btn-block" id="checkout-btn">
						Checkout
					</button>
				</div>
			</div>
		</div>

		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			:root {
				--primary-color: #8B4513;
				--secondary-color: #D4A574;
				--accent-color: #CD853F;
				--text-dark: #2C1810;
				--text-light: #6B5D54;
				--bg-light: #FAF9F7;
				--white: #FFFFFF;
			}

			body {
				font-family: 'Montserrat', sans-serif;
				color: var(--text-dark);
				background-color: var(--bg-light);
				line-height: 1.6;
			}

			h1, h2, h3 {
				font-family: 'Playfair Display', serif;
			}

			.container {
				max-width: 1200px;
				margin: 0 auto;
				padding: 0 2rem;
			}

			/* Navigation */
			.navbar {
				background: var(--white);
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
				position: sticky;
				top: 0;
				z-index: 100;
			}

			.nav-wrapper {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 0.5rem 0;
			}

			.logo img {
				height: 60px;
				display: block;
			}

			.nav-links {
				display: flex;
				list-style: none;
				gap: 2.5rem;
				align-items: center;
			}

			.nav-links a {
				text-decoration: none;
				color: var(--text-dark);
				font-weight: 500;
				font-size: 0.95rem;
				letter-spacing: 0.5px;
				transition: color 0.3s ease;
				position: relative;
			}

			.nav-links a:hover,
			.nav-links a.active {
				color: var(--primary-color);
			}

			.nav-links a.active::after {
				content: '';
				position: absolute;
				bottom: -5px;
				left: 0;
				right: 0;
				height: 2px;
				background: var(--primary-color);
			}

			.search-btn {
				background: none;
				border: none;
				color: var(--text-dark);
				cursor: pointer;
				padding: 0.5rem;
				display: flex;
				align-items: center;
				transition: color 0.3s ease;
			}

			.search-btn:hover {
				color: var(--primary-color);
			}

			.cart-btn {
				background: none;
				border: none;
				color: var(--text-dark);
				cursor: pointer;
				padding: 0.5rem;
				display: flex;
				align-items: center;
				transition: color 0.3s ease;
				position: relative;
			}

			.cart-btn:hover {
				color: var(--primary-color);
			}

			.cart-count {
				position: absolute;
				top: 0;
				right: 0;
				background: var(--primary-color);
				color: var(--white);
				font-size: 0.7rem;
				font-weight: 600;
				padding: 0.15rem 0.4rem;
				border-radius: 10px;
				min-width: 18px;
				text-align: center;
			}

			.cart-count:empty {
				display: none;
			}

			/* Shop Section */
			.shop {
				padding: 4rem 0 6rem;
			}

			.page-title {
				text-align: center;
				font-size: 3.5rem;
				margin-bottom: 1rem;
				color: var(--text-dark);
			}

			.page-subtitle {
				text-align: center;
				font-size: 1.2rem;
				color: var(--text-light);
				margin-bottom: 4rem;
			}

			.gallery-grid {
				display: grid;
				grid-template-columns: repeat(3, 1fr);
				gap: 2.5rem;
			}

			.gallery-item {
				background: var(--white);
				border-radius: 8px;
				overflow: hidden;
				box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
				transition: transform 0.3s ease, box-shadow 0.3s ease;
				cursor: pointer;
			}

			.gallery-item:hover {
				transform: translateY(-8px);
				box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
			}

			.item-image {
				width: 100%;
				height: 300px;
				overflow: hidden;
			}

			.item-image img {
				width: 100%;
				height: 100%;
				object-fit: cover;
				transition: transform 0.5s ease;
			}

			.gallery-item:hover .item-image img {
				transform: scale(1.1);
			}

			.gallery-item h3 {
				padding: 1.5rem 1.5rem 0.5rem;
				font-size: 1.4rem;
				color: var(--text-dark);
			}

			.price {
				padding: 0 1.5rem 0.5rem;
				font-size: 1.2rem;
				font-weight: 600;
				color: var(--primary-color);
			}

			.item-actions {
				padding: 0 1.5rem 1.5rem;
				display: flex;
				gap: 0.75rem;
			}

			.btn {
				padding: 0.75rem 1.5rem;
				border: none;
				border-radius: 4px;
				font-size: 0.95rem;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
				flex: 1;
			}

			.btn-primary {
				background: var(--primary-color);
				color: var(--white);
			}

			.btn-primary:hover {
				background: var(--text-dark);
				transform: translateY(-2px);
			}

			.btn-secondary {
				background: var(--white);
				color: var(--primary-color);
				border: 2px solid var(--primary-color);
			}

			.btn-secondary:hover {
				background: var(--primary-color);
				color: var(--white);
			}

			.btn-block {
				width: 100%;
			}

			/* Cart Sidebar */
			.cart-sidebar {
				position: fixed;
				top: 0;
				right: 0;
				bottom: 0;
				left: 0;
				z-index: 1000;
				pointer-events: none;
			}

			.cart-sidebar.open {
				pointer-events: all;
			}

			.cart-overlay {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(0, 0, 0, 0.5);
				opacity: 0;
				transition: opacity 0.3s ease;
			}

			.cart-sidebar.open .cart-overlay {
				opacity: 1;
			}

			.cart-content {
				position: absolute;
				top: 0;
				right: 0;
				bottom: 0;
				width: 400px;
				max-width: 90vw;
				background: var(--white);
				box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
				transform: translateX(100%);
				transition: transform 0.3s ease;
				display: flex;
				flex-direction: column;
			}

			.cart-sidebar.open .cart-content {
				transform: translateX(0);
			}

			.cart-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 1.5rem;
				border-bottom: 1px solid #e0e0e0;
			}

			.cart-header h2 {
				font-size: 1.5rem;
				margin: 0;
			}

			.cart-close {
				background: none;
				border: none;
				color: var(--text-dark);
				cursor: pointer;
				padding: 0.5rem;
				display: flex;
				align-items: center;
				transition: color 0.3s ease;
			}

			.cart-close:hover {
				color: var(--primary-color);
			}

			.cart-items {
				flex: 1;
				overflow-y: auto;
				padding: 1.5rem;
			}

			.cart-item {
				display: flex;
				gap: 1rem;
				margin-bottom: 1.5rem;
				padding-bottom: 1.5rem;
				border-bottom: 1px solid #e0e0e0;
			}

			.cart-item:last-child {
				border-bottom: none;
			}

			.cart-item-image {
				width: 80px;
				height: 80px;
				object-fit: cover;
				border-radius: 4px;
			}

			.cart-item-details {
				flex: 1;
				display: flex;
				flex-direction: column;
				gap: 0.5rem;
			}

			.cart-item-name {
				font-weight: 600;
				color: var(--text-dark);
			}

			.cart-item-price {
				color: var(--primary-color);
				font-weight: 600;
			}

			.cart-item-quantity {
				display: flex;
				align-items: center;
				gap: 0.5rem;
			}

			.quantity-btn {
				background: var(--bg-light);
				border: 1px solid #e0e0e0;
				color: var(--text-dark);
				width: 28px;
				height: 28px;
				border-radius: 4px;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 1rem;
				transition: all 0.2s ease;
			}

			.quantity-btn:hover {
				background: var(--primary-color);
				color: var(--white);
				border-color: var(--primary-color);
			}

			.quantity-value {
				min-width: 30px;
				text-align: center;
				font-weight: 600;
			}

			.cart-item-remove {
				background: none;
				border: none;
				color: var(--text-light);
				cursor: pointer;
				padding: 0.25rem;
				font-size: 0.85rem;
				text-decoration: underline;
				transition: color 0.2s ease;
			}

			.cart-item-remove:hover {
				color: #dc3545;
			}

			.cart-empty {
				text-align: center;
				padding: 3rem 1rem;
				color: var(--text-light);
			}

			.cart-footer {
				padding: 1.5rem;
				border-top: 1px solid #e0e0e0;
			}

			.cart-total {
				display: flex;
				justify-content: space-between;
				font-size: 1.3rem;
				font-weight: 700;
				margin-bottom: 1rem;
				color: var(--text-dark);
			}

			/* Responsive Design */
			@media (max-width: 768px) {
				.nav-links {
					gap: 1.5rem;
				}

				.page-title {
					font-size: 2.5rem;
				}

				.page-subtitle {
					font-size: 1rem;
				}

				.gallery-grid {
					grid-template-columns: 1fr;
					gap: 2rem;
				}
			}

			@media (max-width: 480px) {
				.container {
					padding: 0 1rem;
				}

				.nav-links {
					gap: 1rem;
					font-size: 0.85rem;
				}

				.logo img {
					height: 50px;
				}

				.page-title {
					font-size: 2rem;
				}
			}
		</style>

		<script>
			// Product data (imported from products.ts at build time)
			const products = [
				{
					id: 'glass-circle-art',
					name: 'Glass Circle Art',
					price: 15000,
					image: '/donut-piece.jpg',
					description: 'Handmade stained glass circle piece'
				},
				{
					id: 'stained-glass-creation',
					name: 'Stained Glass Creation',
					price: 18000,
					image: '/IMG_4033_cropped.jpeg',
					description: 'Handmade stained glass piece'
				},
				{
					id: 'glass-art-piece',
					name: 'Glass Art Piece',
					price: 22000,
					image: '/IMG_4115.JPG',
					description: 'Handmade stained glass piece'
				},
				{
					id: 'artistic-glass-work',
					name: 'Artistic Glass Work',
					price: 19500,
					image: '/IMG_4447.jpg',
					description: 'Handmade stained glass piece'
				},
				{
					id: 'glass-masterpiece',
					name: 'Glass Masterpiece',
					price: 25000,
					image: '/IMG_7793.jpg',
					description: 'Handmade stained glass piece'
				},
				{
					id: 'glass-rose',
					name: 'Glass Rose',
					price: 17500,
					image: '/IMG_8510_cropped.jpeg',
					description: 'Handmade stained glass rose'
				}
			];

			// Cart state
			let cart = [];

			// Load cart from localStorage on page load
			function loadCart() {
				const savedCart = localStorage.getItem('cart');
				if (savedCart) {
					cart = JSON.parse(savedCart);
					updateCartUI();
				}
			}

			// Save cart to localStorage
			function saveCart() {
				localStorage.setItem('cart', JSON.stringify(cart));
				updateCartUI();
			}

			// Add item to cart
			function addToCart(productId) {
				const product = products.find(p => p.id === productId);
				if (!product) return;

				const existingItem = cart.find(item => item.id === productId);
				if (existingItem) {
					existingItem.quantity += 1;
				} else {
					cart.push({ ...product, quantity: 1 });
				}
				saveCart();
				openCart();
			}

			// Remove item from cart
			function removeFromCart(productId) {
				cart = cart.filter(item => item.id !== productId);
				saveCart();
			}

			// Update item quantity
			function updateQuantity(productId, newQuantity) {
				const item = cart.find(item => item.id === productId);
				if (item) {
					if (newQuantity <= 0) {
						removeFromCart(productId);
					} else {
						item.quantity = newQuantity;
						saveCart();
					}
				}
			}

			// Calculate cart total
			function getCartTotal() {
				return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
			}

			// Format price
			function formatPrice(priceInCents) {
				return `$${(priceInCents / 100).toFixed(2)}`;
			}

			// Update cart UI
			function updateCartUI() {
				// Update cart count
				const cartCount = cart.reduce((total, item) => total + item.quantity, 0);
				const cartCountEl = document.getElementById('cart-count');
				if (cartCountEl) {
					cartCountEl.textContent = cartCount > 0 ? cartCount : '';
				}

				// Update cart items
				const cartItemsEl = document.getElementById('cart-items');
				if (cartItemsEl) {
					if (cart.length === 0) {
						cartItemsEl.innerHTML = '<div class="cart-empty">Your cart is empty</div>';
					} else {
						cartItemsEl.innerHTML = cart.map(item => `
							<div class="cart-item">
								<img src="${item.image}" alt="${item.name}" class="cart-item-image" />
								<div class="cart-item-details">
									<div class="cart-item-name">${item.name}</div>
									<div class="cart-item-price">${formatPrice(item.price)}</div>
									<div class="cart-item-quantity">
										<button class="quantity-btn" data-action="decrease" data-product-id="${item.id}">-</button>
										<span class="quantity-value">${item.quantity}</span>
										<button class="quantity-btn" data-action="increase" data-product-id="${item.id}">+</button>
									</div>
									<button class="cart-item-remove" data-product-id="${item.id}">Remove</button>
								</div>
							</div>
						`).join('');
					}
				}

				// Update cart total
				const cartTotalEl = document.getElementById('cart-total');
				if (cartTotalEl) {
					cartTotalEl.textContent = formatPrice(getCartTotal());
				}
			}

			// Open cart sidebar
			function openCart() {
				const cartSidebar = document.getElementById('cart-sidebar');
				if (cartSidebar) {
					cartSidebar.classList.add('open');
					document.body.style.overflow = 'hidden';
				}
			}

			// Close cart sidebar
			function closeCart() {
				const cartSidebar = document.getElementById('cart-sidebar');
				if (cartSidebar) {
					cartSidebar.classList.remove('open');
					document.body.style.overflow = '';
				}
			}

			// Checkout with Stripe
			async function checkout(items = null) {
				try {
					const checkoutItems = items || cart;
					if (checkoutItems.length === 0) {
						alert('Your cart is empty');
						return;
					}

					const response = await fetch('/api/create-checkout-session', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ items: checkoutItems }),
					});

					const { url } = await response.json();
					window.location.href = url;
				} catch (error) {
					console.error('Checkout error:', error);
					alert('Something went wrong. Please try again.');
				}
			}

			// Event listeners
			document.addEventListener('DOMContentLoaded', () => {
				loadCart();

				// Add to cart buttons
				document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
					btn.addEventListener('click', (e) => {
						const productId = e.target.dataset.productId;
						addToCart(productId);
					});
				});

				// Buy now buttons
				document.querySelectorAll('.buy-now-btn').forEach(btn => {
					btn.addEventListener('click', async (e) => {
						const productId = e.target.dataset.productId;
						const product = products.find(p => p.id === productId);
						if (product) {
							await checkout([{ ...product, quantity: 1 }]);
						}
					});
				});

				// Cart toggle button
				const cartToggle = document.getElementById('cart-toggle');
				if (cartToggle) {
					cartToggle.addEventListener('click', openCart);
				}

				// Cart close button
				const cartClose = document.getElementById('cart-close');
				if (cartClose) {
					cartClose.addEventListener('click', closeCart);
				}

				// Cart overlay
				const cartOverlay = document.getElementById('cart-overlay');
				if (cartOverlay) {
					cartOverlay.addEventListener('click', closeCart);
				}

				// Cart item actions (using event delegation)
				const cartItems = document.getElementById('cart-items');
				if (cartItems) {
					cartItems.addEventListener('click', (e) => {
						const target = e.target;
						
						// Quantity buttons
						if (target.classList.contains('quantity-btn')) {
							const productId = target.dataset.productId;
							const action = target.dataset.action;
							const item = cart.find(i => i.id === productId);
							
							if (item) {
								if (action === 'increase') {
									updateQuantity(productId, item.quantity + 1);
								} else if (action === 'decrease') {
									updateQuantity(productId, item.quantity - 1);
								}
							}
						}
						
						// Remove button
						if (target.classList.contains('cart-item-remove')) {
							const productId = target.dataset.productId;
							removeFromCart(productId);
						}
					});
				}

				// Checkout button
				const checkoutBtn = document.getElementById('checkout-btn');
				if (checkoutBtn) {
					checkoutBtn.addEventListener('click', () => checkout());
				}
			});
		</script>
	</body>
</html>
